<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>REDSTONE クールタイム管理</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0gkCfZZVOpJVIOgldr00RoEny2mtnAws",
      authDomain: "redstone-cooltime.firebaseapp.com",
      databaseURL: "https://redstone-cooltime-default-rtdb.firebaseio.com",
      projectId: "redstone-cooltime",
      storageBucket: "redstone-cooltime.appspot.com",
      messagingSenderId: "940339332591",
      appId: "1:940339332591:web:7da07ad6db29278a61621a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const players = 8;
    const localState = {};

    for (let i = 1; i <= players; i++) {
      document.addEventListener("DOMContentLoaded", () => {
        const nameInput = document.getElementById(`name${i}`);
        const nameButton = document.getElementById(`setName${i}`);
        const startButton = document.getElementById(`start${i}`);

        nameButton.addEventListener("click", () => {
          const name = nameInput.value || `Player${i}`;
          set(ref(db, `players/player${i}`), {
            name,
            phase: "ready",
            startTime: 0
          });
        });

        startButton.addEventListener("click", async () => {
          const serverTimeOffsetSnap = await get(ref(db, '.info/serverTimeOffset'));
          const offset = serverTimeOffsetSnap.val() || 0;
          const serverTime = Date.now() + offset;
          set(ref(db, `players/player${i}`), {
            ...localState[`player${i}`],
            phase: "active",
            startTime: serverTime
          });
        });
      });

      // 監視して状態をローカルに保存
      onValue(ref(db, `players/player${i}`), (snapshot) => {
        const data = snapshot.val();
        localState[`player${i}`] = data;
        updateDisplay(i);
      });
    }

    // 秒ごとにUI更新
    setInterval(() => {
      for (let i = 1; i <= players; i++) {
        updateDisplay(i);
      }
    }, 1000);

    function updateDisplay(i) {
      const data = localState[`player${i}`];
      if (!data) return;

      const nameEl = document.getElementById(`displayName${i}`);
      const timerEl = document.getElementById(`timer${i}`);

      nameEl.textContent = data.name || `Player${i}`;

      if (data.phase === "ready") {
        timerEl.textContent = "-";
      } else {
        const now = Date.now();
        const phaseDuration = data.phase === "active" ? 12000 : 300000;
        const elapsed = now - data.startTime;
        const remaining = Math.max(0, phaseDuration - elapsed);
        const seconds = Math.ceil(remaining / 1000);
        timerEl.textContent = seconds;

        if (remaining <= 0 && data.phase === "active") {
          // フェーズ遷移 active → cooldown
          set(ref(db, `players/player${i}`), {
            ...data,
            phase: "cooldown",
            startTime: now
          });
        }
      }
    }
  </script>
</head>
<body>
  <h1>REDSTONE クールタイム管理</h1>

  <div id="players">
    <!-- プレイヤー枠は8つ -->
    ${[...Array(8)].map((_, i) => `
      <div style="margin-bottom: 20px;">
        <input type="text" id="name${i + 1}" placeholder="プレイヤー名">
        <button id="setName${i + 1}">決定</button>
        <button id="start${i + 1}">開始</button><br>
        名前: <span id="displayName${i + 1}">-</span><br>
        タイマー: <span id="timer${i + 1}">-</span>
      </div>
    `).join("")}
  </div>
</body>
</html>
