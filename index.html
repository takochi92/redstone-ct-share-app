<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>REDSTONE クールタイム共有</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .player {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      background-color: #f5f5f5;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0gkCfZZVOpJVIOgldr00RoEny2mtnAws",
      authDomain: "redstone-cooltime.firebaseapp.com",
      databaseURL: "https://redstone-cooltime-default-rtdb.firebaseio.com",
      projectId: "redstone-cooltime",
      storageBucket: "redstone-cooltime.appspot.com",
      messagingSenderId: "940339332591",
      appId: "1:940339332591:web:7da07ad6db29278a61621a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const players = 8;
    const localState = {};
    let serverTimeOffset = 0;

    async function syncServerTimeOffset() {
      const snap = await get(ref(db, ".info/serverTimeOffset"));
      serverTimeOffset = snap.val() || 0;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await syncServerTimeOffset();

      for (let i = 1; i <= players; i++) {
        const nameInput = document.getElementById(`name${i}`);
        const setNameBtn = document.getElementById(`setName${i}`);
        const startBtn = document.getElementById(`start${i}`);

        setNameBtn.addEventListener("click", () => {
          const name = nameInput.value.trim() || `Player${i}`;
          set(ref(db, `players/player${i}`), {
            name,
            phase: "ready",
            startTime: 0
          });
        });

        startBtn.addEventListener("click", async () => {
          const serverNow = Date.now() + serverTimeOffset;
          const current = localState[`player${i}`];
          if (!current) return;

          set(ref(db, `players/player${i}`), {
            ...current,
            phase: "active",
            startTime: serverNow
          });
        });

        onValue(ref(db, `players/player${i}`), (snap) => {
          const data = snap.val();
          if (data) {
            localState[`player${i}`] = data;
            updateDisplay(i);
          }
        });
      }

      setInterval(() => {
        for (let i = 1; i <= players; i++) {
          updateDisplay(i);
        }
      }, 1000);
    });

    function updateDisplay(i) {
      const data = localState[`player${i}`];
      if (!data) return;

      const nameEl = document.getElementById(`displayName${i}`);
      const useEl = document.getElementById(`useTimer${i}`);
      const cdEl = document.getElementById(`cooldownTimer${i}`);

      nameEl.textContent = data.name || `Player${i}`;

      const now = Date.now() + serverTimeOffset;

      if (data.phase === "ready") {
        useEl.textContent = "0";
        cdEl.textContent = "0";
        return;
      }

      const elapsed = now - data.startTime;

      if (data.phase === "active") {
        const remaining = Math.max(0, 12000 - elapsed);
        useEl.textContent = Math.ceil(remaining / 1000);
        cdEl.textContent = "0";

        // フェーズ移行
        if (remaining <= 0) {
          set(ref(db, `players/player${i}`), {
            ...data,
            phase: "cooldown",
            startTime: now
          });
        }
      } else if (data.phase === "cooldown") {
        useEl.textContent = "0";
        const remaining = Math.max(0, 300000 - elapsed);
        cdEl.textContent = Math.ceil(remaining / 1000);
      }
    }
  </script>
</head>
<body>
  <h1>REDSTONE クールタイム共有</h1>
  <div id="players">
    ${[...Array(8)].map((_, i) => `
      <div class="player">
        <h3>プレイヤー${i + 1}</h3>
        <input type="text" id="name${i + 1}" placeholder="名前を入力" />
        <button id="setName${i + 1}">決定</button>
        <button id="start${i + 1}">開始</button><br />
        名前: <span id="displayName${i + 1}">-</span><br />
        使用：<span id="useTimer${i + 1}">0</span>秒<br />
        クールタイム：<span id="cooldownTimer${i + 1}">0</span>秒
      </div>
    `).join("")}
  </div>
</body>
</html>
