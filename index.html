<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>三顕の騎士 - アリーナ共有タイマー</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      text-align: center;
      margin: 20px;
    }
    h1 {
      font-size: 32px;
    }
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .player-box {
      border: 1px solid #ccc;
      padding: 12px;
      background: white;
      border-radius: 8px;
    }
    input {
      width: 80%;
      margin-bottom: 8px;
    }
    button {
      padding: 6px 12px;
      margin-bottom: 8px;
    }
    .cooldown.red {
      color: red;
      font-weight: bold;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>三顕の騎士</h1>
  <button onclick="startArena()">アリーナ開始</button>
  <p id="arena-timer">残り時間: 0分0秒</p>

  <div class="player-grid" id="playerGrid"></div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const arenaDuration = 300; // 5分（秒）
    let arenaTimeLeft = 0;
    let arenaTimer = null;
    const countdowns = Array(9).fill(0);
    const cooldowns = Array(9).fill(0);

    function startArena() {
      const now = Date.now();
      database.ref("arena/startTime").set(now);
    }

    function updateArenaTimer() {
      const timerEl = document.getElementById("arena-timer");
      const min = Math.floor(arenaTimeLeft / 60);
      const sec = arenaTimeLeft % 60;
      timerEl.textContent = `残り時間: ${min}分${sec}秒`;
    }

    database.ref("arena/startTime").on("value", (snapshot) => {
      const startTime = snapshot.val();
      if (!startTime) return;
      if (arenaTimer) clearInterval(arenaTimer);
      arenaTimer = setInterval(() => {
        const now = Date.now();
        const elapsed = Math.floor((now - startTime) / 1000);
        arenaTimeLeft = Math.max(0, arenaDuration - elapsed);
        updateArenaTimer();
        if (arenaTimeLeft === 0) clearInterval(arenaTimer);
      }, 1000);
    });

    function startCooldown(playerId) {
      const now = Date.now();
      database.ref(`players/player${playerId}`).set({
        cooldownStart: now
      });
    }

    function updateName(playerId) {
      const name = document.getElementById(`name${playerId}`).value;
      database.ref(`players/player${playerId}/name`).set(name);
    }

    function listenForNameChanges(playerId) {
      database.ref(`players/player${playerId}/name`).on("value", (snapshot) => {
        const name = snapshot.val();
        if (name) {
          document.getElementById(`name${playerId}`).value = name;
        }
      });
    }

    // 🔽 プレイヤーの表示と同期処理（即時実行）
    (function () {
      const playerGrid = document.getElementById("playerGrid");

      for (let i = 1; i <= 8; i++) {
        const box = document.createElement("div");
        box.className = "player-box";
        box.innerHTML = `
          <input type="text" id="name${i}" placeholder="プレイヤー${i}" onchange="updateName(${i})" />
          <button onclick="startCooldown(${i})">開始</button>
          <div id="countdown-${i}">残り: 0秒</div>
          <div id="cooldown-${i}" class="cooldown">| クールタイム残り: 0秒</div>
        `;
        playerGrid.appendChild(box);

        database.ref(`players/player${i}`).on("value", (snapshot) => {
          const data = snapshot.val();
          if (!data || !data.cooldownStart) return;
          const now = Date.now();
          const elapsed = Math.floor((now - data.cooldownStart) / 1000);
          countdowns[i] = Math.max(0, 12 - elapsed);
          cooldowns[i] = Math.max(0, 300 - elapsed);
          updatePlayerDisplay(i);
        });

        listenForNameChanges(i);
      }

      setInterval(() => {
        for (let i = 1; i <= 8; i++) {
          if (countdowns[i] > 0) countdowns[i]--;
          if (cooldowns[i] > 0) cooldowns[i]--;
          updatePlayerDisplay(i);
        }
      }, 1000);

      window.updatePlayerDisplay = function (playerId) {
        const countdownEl = document.getElementById(`countdown-${playerId}`);
        const cooldownEl = document.getElementById(`cooldown-${playerId}`);
        countdownEl.textContent = `残り: ${countdowns[playerId]}秒`;
        cooldownEl.textContent = `| クールタイム残り: ${cooldowns[playerId]}秒`;
        if (cooldowns[playerId] > 0 && cooldowns[playerId] <= 30) {
          cooldownEl.classList.add("red");
        } else {
          cooldownEl.classList.remove("red");
        }
      };
    })();
  </script>
</body>
</html>
