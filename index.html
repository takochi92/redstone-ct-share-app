<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>REDSTONE クールタイム共有</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9ff;
      text-align: center;
    }
    .player {
      background: #eef;
      padding: 20px;
      margin: 20px auto;
      border: 1px solid #aaa;
      width: 400px;
      border-radius: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>REDSTONE クールタイム共有</h1>

  <div class="player">
    <h3>プレイヤー1</h3>
    <input id="name1" placeholder="名前を入力" />
    <button id="setName1">決定</button>
    <button id="start1">開始</button><br />
    名前：<span id="displayName1">-</span><br />
    使用：<span id="useTimer1">0</span>秒<br />
    クールタイム：<span id="cooldownTimer1">0</span>秒
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0gkCfZZVOpJVIOgldr00RoEny2mtnAws",
      authDomain: "redstone-cooltime.firebaseapp.com",
      databaseURL: "https://redstone-cooltime-default-rtdb.firebaseio.com",
      projectId: "redstone-cooltime",
      storageBucket: "redstone-cooltime.appspot.com",
      messagingSenderId: "940339332591",
      appId: "1:940339332591:web:7da07ad6db29278a61621a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const path = "players/player1";
    const state = { name: "", phase: "ready", startTime: 0 };

    // サーバー時刻との差を取得
    let offset = 0;
    const offsetRef = ref(getDatabase());
    const offsetSnap = await get(child(offsetRef, ".info/serverTimeOffset"));
    offset = offsetSnap.val() || 0;

    const now = () => Date.now() + offset;

    // 要素の取得
    const nameInput = document.getElementById("name1");
    const setNameBtn = document.getElementById("setName1");
    const startBtn = document.getElementById("start1");
    const nameDisplay = document.getElementById("displayName1");
    const useTimer = document.getElementById("useTimer1");
    const cooldownTimer = document.getElementById("cooldownTimer1");

    // 名前決定
    setNameBtn.addEventListener("click", () => {
      const name = nameInput.value.trim() || "プレイヤー1";
      set(ref(db, path), { name, phase: "ready", startTime: 0 });
    });

    // 開始ボタン
    startBtn.addEventListener("click", () => {
      set(ref(db, path), {
        ...state,
        phase: "active",
        startTime: now()
      });
    });

    // Firebaseからのリアルタイム監視
    onValue(ref(db, path), (snap) => {
      const data = snap.val();
      if (data) {
        state.name = data.name;
        state.phase = data.phase;
        state.startTime = data.startTime;
      }
    });

    // 毎秒更新（DOM描画）
    setInterval(() => {
      nameDisplay.textContent = state.name;

      const elapsed = now() - state.startTime;

      if (state.phase === "ready") {
        useTimer.textContent = "0";
        cooldownTimer.textContent = "0";
      } else if (state.phase === "active") {
        const remain = Math.max(0, 12000 - elapsed);
        useTimer.textContent = Math.ceil(remain / 1000);
        cooldownTimer.textContent = "0";
        if (remain <= 0) {
          // クールタイムに移行
          set(ref(db, path), {
            ...state,
            phase: "cooldown",
            startTime: now()
          });
        }
      } else if (state.phase === "cooldown") {
        useTimer.textContent = "0";
        const remain = Math.max(0, 300000 - elapsed);
        cooldownTimer.textContent = Math.ceil(remain / 1000);
      }
    }, 1000);
  </script>
</body>
</html>
